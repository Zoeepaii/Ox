<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡€æ°§æ©Ÿè¬ç”¨é€£ç·šå·¥å…·</title>
    <style>
        body { font-family: sans-serif; background: #f0f2f5; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; width: 320px; }
        .val { font-size: 60px; font-weight: bold; color: #1a1a1a; }
        button { background: #007aff; color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; cursor: pointer; font-size: 16px; font-weight: 600; }
        #log { font-size: 12px; color: #666; margin-top: 15px; text-align: left; background: #eee; padding: 10px; border-radius: 8px; max-height: 150px; overflow-y: auto; white-space: pre-wrap; }
    </style>
</head>
<body>
<div class="card">
    <div id="status">æº–å‚™æƒæ</div>
    <div class="val" id="spo2-val">--%</div>
    <div id="hr-val">â¤ï¸ -- BPM</div>
    <button id="btn">ğŸ” é–‹å§‹é€£ç·š</button>
    <div id="log">è«‹å…ˆæ’å¥½æ‰‹æŒ‡å†é»æŒ‰éˆ•</div>
</div>

<script>
    const log = (msg) => document.getElementById('log').innerText += msg + "\n";
    const BERRY_SERVICE = '0000ff12-0000-1000-8000-00805f9b34fb';
    const BERRY_CHAR = '0000ff02-0000-1000-8000-00805f9b34fb';
    const STANDARD_OX = 0x1822; // æ¨™æº–é†«ç™‚è¡€æ°§æœå‹™

    document.getElementById('btn').onclick = async () => {
        try {
            document.getElementById('log').innerText = ""; // æ¸…é™¤èˆŠ log
            log("æ­£åœ¨æœå°‹...");
            const device = await navigator.bluetooth.requestDevice({
                acceptAllDevices: true,
                optionalServices: [BERRY_SERVICE, STANDARD_OX, 0xff12, 0x1810, 0x180d]
            });

            log("å·²é¸å–: " + device.name);
            const server = await device.gatt.connect();
            log("é€£ç·šæˆåŠŸï¼Œæ­£åœ¨è®€å–æ¸…å–®...");

            // ã€æ ¸å¿ƒåµéŒ¯ã€‘åˆ—å‡ºé€™å°æ©Ÿå™¨æ‰€æœ‰çš„æœå‹™
            const services = await server.getPrimaryServices();
            log("é€™å°æ©Ÿå™¨æ“æœ‰çš„æœå‹™ IDï¼š");
            services.forEach(s => log("-> " + s.uuid));

            // å˜—è©¦å°‹æ‰¾ BerryMed æœå‹™
            try {
                const service = await server.getPrimaryService(BERRY_SERVICE);
                const char = await service.getCharacteristic(BERRY_CHAR);
                await char.startNotifications();
                log("âœ… æˆåŠŸå°æ¥ BerryMed å”è­°ï¼");
                
                char.addEventListener('characteristicvaluechanged', (e) => {
                    const d = e.target.value;
                    if (d.byteLength >= 5) {
                        const s = d.getUint8(4) & 0x7f;
                        const h = d.getUint8(2) & 0x7f;
                        if(s > 0) {
                            document.getElementById('spo2-val').innerText = s + "%";
                            document.getElementById('hr-val').innerText = "â¤ï¸ " + h + " BPM";
                        }
                    }
                });
            } catch(e) {
                log("âŒ æ­¤è¨­å‚™ä¸æ”¯æ´ BerryMed å”è­°ï¼Œè«‹çœ‹ä¸Šæ–¹åˆ—å‡ºçš„ IDã€‚");
            }

        } catch (err) {
            log("å‡ºéŒ¯äº†: " + err);
        }
    };
</script>
</body>
</html>
